'use strict';

var cluster = require('cluster');
var async = require('async');

var _this = {
    dbWrapper:null,
    cfg:null,
    s2sClient:null,

    workerInitExecuted:false,

    initWorker:function(workerID){
        var res = _this.dbWrapper.chatHistory.chain().find({'$loki':{'$gt':-Infinity}}).simplesort('$loki').data();
        var msgRes = [];
        for (let i = 0; i < res.length; i++) {
            msgRes.push({
                '$loki':res[i].$loki,
                'username':res[i].username,
                'time':res[i].time,
                'message':res[i].message
            });
        }
        cluster.workers[workerID].send({
            messageType:"c2sWorkerChatSend",
            payload:msgRes
        });

        res = _this.dbWrapper.users.find({'loggedIn':true});
        var usrRes = [];
        for (let i = 0; i < res.length; i++) {
            usrRes.push({
                'username':res[i].username,
            });
        }
        cluster.workers[workerID].send({
            messageType:"c2sWorkerLogin",
            payload:usrRes
        });

        if (_this.workerInit===false) {
            _this.workerInit = true;
            process.on("logoutUser", function(data){
                let ts = data.timestamp;
                _this.s2sClient.logoutClient(data.sessid, ts, function(){});
                _this.dbWrapper.userHistory.insert({
                    "username":data.username,
                    "timestamp":ts,
                    "action":"LOGOUT"
                });
                _this.dbWrapper.queueSaving();
            });
            process.on("loginUser", function(data){
                let ts = data.timestamp;
                _this.s2sClient.loginClient(data.username, data.sessid, ts, function(){});
                _this.dbWrapper.userHistory.insert({
                    "username":data.username,
                    "timestamp":ts,
                    "action":"LOGOUT"
                });
                _this.dbWrapper.queueSaving();
            });
            process.on("logoutServer", function(data){
                _this.s2sClient.logoutServer(data.sessid, function(){});
            });
            process.on("loginServer", function(data){
                _this.s2sClient.loginServer(data.ip, data.port, function(){});
            });
        }
    },

	handle: function(request){
        var method = request.data.method[0];
		switch(method) {
            case 'login': {
                _this.login(request);
            } break;
            case 'register': {
                _this.register(request);
            } break;
            case 'logout': {
                _this.logout(request);
            } break;
            case 'chatSend': {
                _this.chatSend(request);
            } break;
            case 'chatGet': {
                _this.chatGet(request);
            } break;
            case 'getUserHistory': {
                _this.getUserHistory(request);
            } break;
            case 'heartbeat': {
                _this.heartbeat(request);
            } break;
        }
	},

    login: function(request){
        var requestID, hash, sessid;
        var workerID = request.workerID;
        requestID = request.reqID;
        sessid = request.sessid;
        hash = request.hash;
        request = request.data;

        var username = request.param[0].$.user;
        var res = _this.dbWrapper.users.by('username', username);

        if (res!=null && res.password!=null) {
            if (res.loggedIn===false) {
                if (res.password===hash) {
                    // Success
                    res.loggedIn = true;
                    res.sessid = sessid;
                    res.heartbeat = Date.now();
                    res.handledByMe = true;
                    res.handlerIpPort = null;
                    _this.dbWrapper.users.update(res);

                    cluster.workers[workerID].send({
                        messageType:"c2sWorker",
                        payload:{
                            reqID:requestID,
                            header:{'Content-Type': 'text/plain'},
                            data:{
                                response:{
                                    $:{type:"c2s"},
                                    "status":["accepted"],
                                    "status-code":[1],
                                    "sessid":[sessid]
                                }
                            }
                        }
                    });

                    let ts = Date.now();
                    _this.s2sClient.loginClient(username, sessid, ts, function(){});
                    _this.dbWrapper.userHistory.insert({
                        "username":username,
                        "timestamp":ts,
                        "action":"LOGIN"
                    });
                    _this.dbWrapper.queueSaving();

                    for (var key in cluster.workers) {
                        if (cluster.workers[key]!=null) {
                            cluster.workers[key].send({
                                'messageType':'c2sWorkerLogin',
                                'payload':[{
                                    'username':username
                                }]
                            });
                        }
                    }
                } else {
                    // Fail
                    cluster.workers[workerID].send({
                        messageType:"c2sWorker",
                        payload:{
                            reqID:requestID,
                            header:{'Content-Type': 'text/plain'},
                            data:{
                                response:{
                                    $:{type:"c2s"},
                                    "status":["rejected"],
                                    "status-code":[3],
                                    "message":["Wrong password."]
                                }
                            }
                        }
                    });
                }
            } else {
                // Already logged-in
                cluster.workers[workerID].send({
                    messageType:"c2sWorker",
                    payload:{
                        reqID:requestID,
                        header:{'Content-Type': 'text/plain'},
                        data:{
                            response:{
                                $:{type:"c2s"},
                                "status":["rejected"],
                                "status-code":[5],
                                "message":["Already logged-in."]
                            }
                        }
                    }
                });
            }
        } else {
            cluster.workers[workerID].send({
                messageType:"c2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            $:{type:"c2s"},
                            "status":["rejected"],
                            "status-code":[4],
                            "message":["User doesn't exist."]
                        }
                    }
                }
            });
        }
    },

    logout: function(request){
        var requestID;
        var workerID = request.workerID;
        requestID = request.reqID;
        request = request.data;

        var sessid = request.param[0].$.sessid;
        var res = _this.dbWrapper.users.find({"sessid":sessid});

        if (res!=null && res.length>0 && res[0].sessid===sessid) {
            res[0].loggedIn = false;
            res[0].sessid = null;
            res[0].heartbeat = null;
            res[0].handledByMe = null;
            res[0].handlerIpPort = null;
            _this.dbWrapper.users.update(res[0]);

            cluster.workers[workerID].send({
                messageType:"c2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            $:{type:"c2s"},
                            "status":["accepted"],
                            "status-code":[1]
                        }
                    }
                }
            });

            let ts = Date.now();
            _this.s2sClient.logoutClient(sessid, ts, function(){});
            _this.dbWrapper.userHistory.insert({
                "username":res[0].username,
                "timestamp":ts,
                "action":"LOGOUT"
            });
            _this.dbWrapper.queueSaving();

            for (var key in cluster.workers) {
                if (cluster.workers[key]!=null) {
                    cluster.workers[key].send({
                        'messageType':'c2sWorkerLogout',
                        'payload':[{
                            'username':res[0].username
                        }]
                    });
                }
            }
        } else {
            cluster.workers[workerID].send({
                messageType:"c2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            $:{type:"c2s"},
                            "status":["rejected"],
                            "status-code":[3],
                            "message":["Session expired."]
                        }
                    }
                }
            });
        }
    },

    register: function(request){
        var requestID, hash;
        var workerID = request.workerID;
        requestID = request.reqID;
        hash = request.hash;
        request = request.data;

        var username = request.param[0].$.user;
        var password = hash;

        var res = _this.dbWrapper.users.insert({
            "username":username,
            "password":password,
            "loggedIn":false,
            "sessid":null,
            "heartbeat":null,
            "handledByMe":false,
            "handlerIpPort":null
        });

        if (res.username===username) {
            // Success
            _this.dbWrapper.queueSaving();

            cluster.workers[workerID].send({
                messageType:"c2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            $:{type:"c2s"},
                            "status":["accepted"],
                            "status-code":[1]
                        }
                    }
                }
            });

            _this.s2sClient.registerClient(username, password, function(){});
        } else {
            // Fail
            cluster.workers[workerID].send({
                messageType:"c2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            $:{type:"c2s"},
                            "status":["rejected"],
                            "status-code":[3],
                            "message":["Duplicate entry."]
                        }
                    }
                }
            });
        }
    },

    chatSend:function(request){
        var requestID;
        var workerID = request.workerID;
        requestID = request.reqID;
        request = request.data;

        var sessid = request.param[0].$.sessid;
        var message = request.param[0].$.message;

        var res = _this.dbWrapper.users.find({"sessid":sessid});

        if (res!=null && res.length>0 && res[0].sessid===sessid) {
            var msgRes = _this.dbWrapper.chatHistory.insert({
                'username':res[0].username,
                'time':Date.now(),
                'message':message
            });
            _this.dbWrapper.queueSaving();

            var servers = _this.dbWrapper.servers.find({"loggedIn":true});
            for (var i = 0; i < servers.length; i++) {
                _this.s2sClient.chatSendClient(servers[i].ip, servers[i].port, {
                    'username':msgRes.username,
                    'time':msgRes.time,
                    'message':msgRes.message
                }, function(){
                    // Berhasil ngirim
                });
            }

            _this.dbWrapper.queueC2SWorkerChatSend({
                '$loki':msgRes.$loki,
                'username':msgRes.username,
                'time':msgRes.time,
                'message':msgRes.message
            });
            cluster.workers[workerID].send({
                messageType:"c2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            $:{type:"c2s"},
                            "status":["accepted"],
                            "status-code":[1]
                        }
                    }
                }
            });
        } else {
            cluster.workers[workerID].send({
                messageType:"c2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            $:{type:"c2s"},
                            "status":["rejected"],
                            "status-code":[3],
                            "message":["Session expired."]
                        }
                    }
                }
            });
        }
    },

    chatGet:function(request){
        var requestID;
        var workerID = request.workerID;
        requestID = request.reqID;
        request = request.data;

        var time = parseInt(request.param[0].$.time);
        var messages = _this.dbWrapper.chatHistory.find({'time':{'$gt':time}});

        if (messages!=null && messages.length>0) {
            var messageArray = [];
            var nextTime = 0;

            async.each(messages, function(message, callback){
                messageArray.push({
                    $:{
                        "username":message.username,
                        "time":message.time,
                        "message":message.message
                    }
                });
                nextTime = (message.time>nextTime)?message.time:nextTime;
                async.setImmediate(function(){
                    callback();
                });
            }, function() {
                cluster.workers[workerID].send({
                    messageType:"c2sWorker",
                    payload:{
                        reqID:requestID,
                        header:{'Content-Type': 'text/plain'},
                        data:{
                            response:{
                                $:{type:"c2s"},
                                "status":["accepted"],
                                "status-code":[1],
                                "time":[nextTime],
                                "messages":[{"message":messageArray}]
                            }
                        }
                    }
                });
            });
        } else {
            cluster.workers[workerID].send({
                messageType:"c2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            $:{type:"c2s"},
                            "status":["accepted"],
                            "status-code":[1],
                            "time":[time]
                        }
                    }
                }
            });
        }
    },

    getUserHistory:function(request){
        var requestID;
        var workerID = request.workerID;
        requestID = request.reqID;
        request = request.data;

        var time = parseInt(request.param[0].$.time);
        var histories = _this.dbWrapper.userHistory.find({'timestamp':{'$gt':time}});

        if (histories!=null && histories.length>0) {
            var historyArray = [];
            var nextTime = 0;

            async.each(histories, function(history, callback){
                historyArray.push({
                    $:{
                        "username":history.username,
                        "timestamp":history.timestamp,
                        "action":history.action
                    }
                });
                nextTime = (history.time>nextTime)?history.time:nextTime;
                async.setImmediate(function(){
                    callback();
                });
            }, function() {
                cluster.workers[workerID].send({
                    messageType:"c2sWorker",
                    payload:{
                        reqID:requestID,
                        header:{'Content-Type': 'text/plain'},
                        data:{
                            response:{
                                $:{type:"c2s"},
                                "status":["accepted"],
                                "status-code":[1],
                                "time":[nextTime],
                                "userHistories":[{"userHistory":historyArray}]
                            }
                        }
                    }
                });
            });
        } else {
            cluster.workers[workerID].send({
                messageType:"c2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            $:{type:"c2s"},
                            "status":["accepted"],
                            "status-code":[1],
                            "time":[time]
                        }
                    }
                }
            });
        }
    },

    heartbeat:function(request){
        var requestID;
        requestID = request.reqID;
        var workerID = request.workerID;
        request = request.data;

        var sessid = request.param[0].$.sessid;
        var res = _this.dbWrapper.users.find({'sessid':sessid});

        if (res!=null && res.length===1 && res[0]!=null && res[0].username!=null) {
            res[0].heartbeat = Date.now();
            res[0].handledByMe = true;
            res[0].handlerIpPort = null;
            _this.dbWrapper.users.update(res[0]);

            cluster.workers[workerID].send({
                messageType:"c2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            $:{type:"c2s"},
                            "status":["accepted"],
                            "status-code":[1]
                        }
                    }
                }
            });
        } else {
            cluster.workers[workerID].send({
                messageType:"c2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            $:{type:"c2s"},
                            "status":["rejected"],
                            "status-code":[3],
                            "message":['Session expired.']
                        }
                    }
                }
            });
        }
    }
};

module.exports = _this;
