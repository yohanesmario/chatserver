'use strict';

var cluster = require('cluster');
var async = require('async');
var xml2js = require('xml2js');
var parseString = xml2js.parseString;

var _this = {
    dbWrapper:null,
    cfg:null,
    s2sClient:null,

	handle: function(request){
        var method = request.data.method[0];
		switch(method) {
            case 'registrasiServer': {
                _this.registrasiServer(request);
            } break;
            case 'loginServer': {
                _this.loginServer(request);
            } break;
            case 'registrasiClient': {
                _this.registrasiClient(request);
            } break;
            case 'loginClient': {
                _this.loginClient(request);
            } break;
            case 'chatSendClient': {
                _this.chatSendClient(request);
            } break;
            case 'logoutClient': {
                _this.logoutClient(request);
            } break;
            case 'logoutServer': {
                _this.logoutServer(request);
            } break;
            case 'serverHeartbeat': {
                _this.serverHeartbeat(request);
            } break;
            case 'listRegisteredServer': {
                _this.listRegisteredServer(request);
            } break;
        }
	},

    registrasiServer:function(request){
        var requestID, hash;
        requestID = request.reqID;
        var workerID = request.workerID;
        hash = request.hash;
        request = request.data;
        var ipPort = request.param[0].$.ip+":"+request.param[0].$.port;

        var res = _this.dbWrapper.servers.find({"ipPort": ipPort});

        if (res!=null && res.length>0 && res[0].ipPort===ipPort) {
            // Already registered
            cluster.workers[workerID].send({
                messageType:"s2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            "$":{"type":"s2s"},
                            "status":["rejected"],
                            "status-code":[3],
                            "message":['duplicate identifier']
                        }
                    }
                }
            });
        } else {
            let inserted = _this.dbWrapper.servers.insert({
                "ipPort":ipPort,
                "ip":request.param[0].$.ip,
                "port":request.param[0].$.port,
                "password":hash,
                "loggedIn":false,
                "sessid":null,
                "mysessid":null,
                "heartbeat":null
            });
            _this.dbWrapper.servers.update(inserted);
            _this.cfg.config.serverHook.push({
                'ip':request.param[0].$.ip,
                'port':parseInt(request.param[0].$.port)
            });
            _this.cfg.serverHook.push({
                'ip':request.param[0].$.ip,
                'port':parseInt(request.param[0].$.port)
            });
            _this.dbWrapper.queueSaving();
            // Success
            cluster.workers[workerID].send({
                messageType:"s2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            "$":{"type":"s2s"},
                            "status":["accepted"],
                            "status-code":[1]
                        }
                    }
                }
            });
        }
    },

    loginServer:function(request){
        var requestID, sessid, hash;
        requestID = request.reqID;
        var workerID = request.workerID;
        hash = request.hash;
        sessid = request.sessid;
        request = request.data;
        var ipPort = request.param[0].$.ip+":"+request.param[0].$.port;

        var res = _this.dbWrapper.servers.find({'ipPort':ipPort});

        if (res!=null && res.length===1 && res[0].ipPort===ipPort) {
            if (res[0].password===hash) {
                if (res[0].loggedIn!==true) {
                    res[0].loggedIn = true;
                    res[0].sessid = sessid;
                    res[0].heartbeat = Date.now();
                    _this.dbWrapper.servers.update(res[0]);
                    var msgRes = _this.dbWrapper.chatHistory.find({'$loki':{'$gt':-Infinity}});
                    var usrRes = _this.dbWrapper.users.find({'$loki':{'$gt':-Infinity}});
                    var messages = [];
                    var usersBucket = [];
                    var i;
                    for (i = 0; i < msgRes.length; i++) {
                        messages.push({
                            "$":{
                                "username":msgRes[i].username,
                                "time":msgRes[i].time,
                                "message":msgRes[i].message
                            }
                        });
                    }
                    for (i = 0; i < usrRes.length; i++) {
                        var handlerIpPort;
                        if (usrRes[i].handlerIpPort!=null) {
                            handlerIpPort = usrRes[i].handlerIpPort;
                        } else {
                            handlerIpPort = _this.cfg.identifier.ip+":"+_this.cfg.identifier.port;
                        }
                        var usrSessid = usrRes[i].sessid;
                        if (usrSessid==null) {
                            usrSessid = "null";
                        }
                        usersBucket.push({
                            "$":{
                                "username":usrRes[i].username,
                                "password":usrRes[i].password,
                                "loggedIn":((usrRes[i].loggedIn)?"true":"false"),
                                "sessid":usrSessid,
                                "handlerIpPort":handlerIpPort
                            }
                        });
                    }
                    // Success
                    cluster.workers[workerID].send({
                        messageType:"s2sWorker",
                        payload:{
                            reqID:requestID,
                            header:{'Content-Type': 'text/plain'},
                            data:{
                                response:{
                                    "$":{"type":"s2s"},
                                    "status":["accepted"],
                                    "status-code":[1],
                                    "sessid":sessid,
                                    "messages":[{
                                        "message":messages
                                    }],
                                    "users":[{
                                        "user":usersBucket
                                    }]
                                }
                            }
                        }
                    }, function(){
                        if (res[0].mysessid==null) {
                            async.setImmediate(function(){
                                var loginServerCallback = function(r){
                                    parseString(r, function(err, d){
                                        var srv = _this.dbWrapper.servers.find({'ipPort': ipPort});
                                        if (srv!=null && srv.length===1 && srv[0].mysessid===null) {
                                            srv[0].mysessid = d.response.sessid[0];
                                            _this.dbWrapper.servers.update(srv[0]);
                                        }
                                    });
                                };
                                _this.s2sClient.loginServer(res[0].ip, res[0].port, loginServerCallback);
                            });
                        }
                    });
                } else {
                    // Already logged in
                    cluster.workers[workerID].send({
                        messageType:"s2sWorker",
                        payload:{
                            reqID:requestID,
                            header:{'Content-Type': 'text/plain'},
                            data:{
                                response:{
                                    "$":{"type":"s2s"},
                                    "status":["rejected"],
                                    "status-code":[5],
                                    "message":["already logged-in"]
                                }
                            }
                        }
                    });
                }
            } else {
                // Wrong password
                cluster.workers[workerID].send({
                    messageType:"s2sWorker",
                    payload:{
                        reqID:requestID,
                        header:{'Content-Type': 'text/plain'},
                        data:{
                            response:{
                                "$":{"type":"s2s"},
                                "status":["rejected"],
                                "status-code":[4],
                                "message":["wrong password"]
                            }
                        }
                    }
                });
            }
        } else {
            // ip:port doesn't exist
            cluster.workers[workerID].send({
                messageType:"s2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            "$":{"type":"s2s"},
                            "status":["rejected"],
                            "status-code":[3],
                            "message":['identifier doesn\'t exist']
                        }
                    }
                }
            });
        }
    },

    registrasiClient:function(request){
        var requestID;
        requestID = request.reqID;
        var workerID = request.workerID;
        request = request.data;

        var srv = _this.dbWrapper.servers.find({"sessid":request.param[0].$.sessid});
        if (srv!=null && srv.length===1) {
            var res = _this.dbWrapper.users.insert({
                "username":request.param[0].$.username,
                "password":request.param[0].$.password,
                "loggedIn":false,
                "sessid":null,
                "heartbeat":null,
                "handledByMe":false,
                "handlerIpPort":null
            });
            _this.dbWrapper.queueSaving();

            if (res!=null && res.username===request.param[0].$.username) {
                cluster.workers[workerID].send({
                    messageType:"s2sWorker",
                    payload:{
                        reqID:requestID,
                        header:{'Content-Type': 'text/plain'},
                        data:{
                            response:{
                                "$":{"type":"s2s"},
                                "status":["accepted"],
                                "status-code":[1]
                            }
                        }
                    }
                });
            } else {
                cluster.workers[workerID].send({
                    messageType:"s2sWorker",
                    payload:{
                        reqID:requestID,
                        header:{'Content-Type': 'text/plain'},
                        data:{
                            response:{
                                "$":{"type":"s2s"},
                                "status":["rejected"],
                                "status-code":[4],
                                "message":["Already registered"]
                            }
                        }
                    }
                });
            }
        } else {
            cluster.workers[workerID].send({
                messageType:"s2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            "$":{"type":"s2s"},
                            "status":["rejected"],
                            "status-code":[3],
                            "message":["session expired"]
                        }
                    }
                }
            });
        }
    },

    loginClient:function(request){
        var requestID;
        requestID = request.reqID;
        var workerID = request.workerID;
        request = request.data;

        var srv = _this.dbWrapper.servers.find({"sessid":request.param[0].$.sessid});
        if (srv!=null && srv.length===1) {
            var res = _this.dbWrapper.users.find({"username":request.param[0].$.username});
            if (res!=null && res.length===1) {
                if (res[0].loggedIn===false) {
                    res[0].loggedIn = true;
                    res[0].sessid = request.param[0].$.csessid;
                    res[0].heartbeat = null;
                    res[0].handledByMe = false;
                    res[0].handlerIpPort = srv[0].ipPort;
                    _this.dbWrapper.users.update(res[0]);

                    cluster.workers[workerID].send({
                        messageType:"s2sWorker",
                        payload:{
                            reqID:requestID,
                            header:{'Content-Type': 'text/plain'},
                            data:{
                                response:{
                                    "$":{"type":"s2s"},
                                    "status":["accepted"],
                                    "status-code":[1]
                                }
                            }
                        }
                    });

                    for (var key in cluster.workers) {
                        if (cluster.workers[key]!=null) {
                            cluster.workers[key].send({
                                'messageType':'c2sWorkerLogin',
                                'payload':[{
                                    'username':request.param[0].$.username
                                }]
                            });
                        }
                    }
                } else {
                    cluster.workers[workerID].send({
                        messageType:"s2sWorker",
                        payload:{
                            reqID:requestID,
                            header:{'Content-Type': 'text/plain'},
                            data:{
                                response:{
                                    "$":{"type":"s2s"},
                                    "status":["rejected"],
                                    "status-code":[5],
                                    "message":["already logged in"]
                                }
                            }
                        }
                    });
                }
            } else {
                cluster.workers[workerID].send({
                    messageType:"s2sWorker",
                    payload:{
                        reqID:requestID,
                        header:{'Content-Type': 'text/plain'},
                        data:{
                            response:{
                                "$":{"type":"s2s"},
                                "status":["rejected"],
                                "status-code":[4],
                                "message":["user doesn't exist"]
                            }
                        }
                    }
                });
            }
        } else {
            cluster.workers[workerID].send({
                messageType:"s2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            "$":{"type":"s2s"},
                            "status":["rejected"],
                            "status-code":[3],
                            "message":["session expired"]
                        }
                    }
                }
            });
        }
    },

    chatSendClient:function(request){
        var requestID;
        requestID = request.reqID;
        var workerID = request.workerID;
        request = request.data;

        var inserted = _this.dbWrapper.chatHistory.insert({
            "username":request.param[0].$.username,
            "time":parseInt(request.param[0].$.time),
            "message":request.param[0].$.message
        });
        _this.dbWrapper.queueSaving();

        if (inserted!=null && inserted.username===request.param[0].$.username) {
            _this.dbWrapper.queueC2SWorkerChatSend({
                '$loki':inserted.$loki,
                'username':inserted.username,
                'time':inserted.time,
                'message':inserted.message
            });
        }

        cluster.workers[workerID].send({
            messageType:"s2sWorker",
            payload:{
                reqID:requestID,
                header:{'Content-Type': 'text/plain'},
                data:{
                    response:{
                        "$":{"type":"s2s"},
                        "status":["accepted"],
                        "status-code":[1]
                    }
                }
            }
        });
    },

    logoutClient:function(request){
        var requestID;
        requestID = request.reqID;
        var workerID = request.workerID;
        request = request.data;

        var srv = _this.dbWrapper.servers.find({"sessid":request.param[0].$.sessid});
        if (srv!=null && srv.length===1) {
            var res = _this.dbWrapper.users.find({"sessid":request.param[0].$.csessid});
            if (res!=null && res.length===1) {
                res[0].loggedIn = false;
                res[0].sessid = null;
                res[0].heartbeat = null;
                res[0].handledByMe = false;
                res[0].handlerIpPort = null;
                _this.dbWrapper.users.update(res[0]);

                cluster.workers[workerID].send({
                    messageType:"s2sWorker",
                    payload:{
                        reqID:requestID,
                        header:{'Content-Type': 'text/plain'},
                        data:{
                            response:{
                                "$":{"type":"s2s"},
                                "status":["accepted"],
                                "status-code":[1]
                            }
                        }
                    }
                });

                for (var key in cluster.workers) {
                    if (cluster.workers[key]!=null) {
                        cluster.workers[key].send({
                            'messageType':'c2sWorkerLogout',
                            'payload':[{
                                'username':res[0].username
                            }]
                        });
                    }
                }
            } else {
                cluster.workers[workerID].send({
                    messageType:"s2sWorker",
                    payload:{
                        reqID:requestID,
                        header:{'Content-Type': 'text/plain'},
                        data:{
                            response:{
                                "$":{"type":"s2s"},
                                "status":["rejected"],
                                "status-code":[4],
                                "message":["user's session expired"]
                            }
                        }
                    }
                });
            }
        } else {
            cluster.workers[workerID].send({
                messageType:"s2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            "$":{"type":"s2s"},
                            "status":["rejected"],
                            "status-code":[3],
                            "message":["session expired"]
                        }
                    }
                }
            });
        }
    },

    logoutServer:function(request){
        var requestID;
        requestID = request.reqID;
        var workerID = request.workerID;
        request = request.data;

        var res = _this.dbWrapper.servers.find({"sessid":request.param[0].$.sessid});
        if (res!=null && res.length===1) {
            res[0].loggedIn = false;
            res[0].sessid = null;
            res[0].mysessid = null;
            res[0].heartbeat = null;
            var usrRes = _this.dbWrapper.users.find({"handlerIpPort":res[0].ipPort});
            if (usrRes!=null && usrRes.length>0) {
                for (var i = 0; i < usrRes.length; i++) {
                    usrRes[i].loggedIn = false;
                    usrRes[i].handledByMe = false;
                    usrRes[i].heartbeat = null;
                    usrRes[i].handlerIpPort = null;
                    usrRes[i].sessid = null;
                    _this.dbWrapper.users.update(usrRes[i]);
                }
            }
            _this.dbWrapper.servers.update(res[0]);
            cluster.workers[workerID].send({
                messageType:"s2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            "$":{"type":"s2s"},
                            "status":["accepted"],
                            "status-code":[1]
                        }
                    }
                }
            });
        } else {
            cluster.workers[workerID].send({
                messageType:"s2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            "$":{"type":"s2s"},
                            "status":["rejected"],
                            "status-code":[3],
                            "message":["session expired"]
                        }
                    }
                }
            });
        }
    },

    serverHeartbeat:function(request){
        var requestID;
        requestID = request.reqID;
        var workerID = request.workerID;
        request = request.data;

        var res = _this.dbWrapper.servers.find({"sessid":request.param[0].$.sessid});
        if (res!=null && res.length===1) {
            res[0].heartbeat = Date.now();
            _this.dbWrapper.servers.update(res[0]);
            cluster.workers[workerID].send({
                messageType:"s2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            "$":{"type":"s2s"},
                            "status":["accepted"],
                            "status-code":[1]
                        }
                    }
                }
            });
        } else {
            cluster.workers[workerID].send({
                messageType:"s2sWorker",
                payload:{
                    reqID:requestID,
                    header:{'Content-Type': 'text/plain'},
                    data:{
                        response:{
                            "$":{"type":"s2s"},
                            "status":["rejected"],
                            "status-code":[3],
                            "message":["session expired"]
                        }
                    }
                }
            });
        }
    },

    listRegisteredServer:function(request){
        var requestID;
        requestID = request.reqID;
        var workerID = request.workerID;
        request = request.data;

        var serverArray = [{
            "$":{
                "ip":_this.cfg.identifier.ip,
                "port":_this.cfg.identifier.port,
                "password":_this.cfg.hash
            }
        }];

        var res = _this.dbWrapper.servers.find({'$loki':{'$gt':-Infinity}});
        if (res!=null) {
            for (var i = 0; i < res.length; i++) {
                serverArray.push({
                    "$":{
                        "ip":res[i].ip,
                        "port":res[i].port,
                        "password":res[i].password
                    }
                });
            }
        }

        cluster.workers[workerID].send({
            messageType:"s2sWorker",
            payload:{
                reqID:requestID,
                header:{'Content-Type': 'text/plain'},
                data:{
                    response:{
                        "$":{"type":"s2s"},
                        "status":["accepted"],
                        "status-code":[1],
                        "servers":[
                            {"server":serverArray}
                        ]
                    }
                }
            }
        });
    }
};

module.exports = _this;
